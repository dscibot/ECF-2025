name: Deploy Java App to AWS

on:
  push:
    branches:
      - main  # DÃ©clencher le pipeline sur un push dans main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ðŸ“Œ Ã‰tape 1 : RÃ©cupÃ©rer le code source
    - name: Checkout code
      uses: actions/checkout@v3

    # ðŸ“Œ Ã‰tape 2 : Installer Java et Maven
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # ðŸ“Œ Ã‰tape 3 : Compiler l'application avec Maven
    - name: Build with Maven
      working-directory: HelloWorld
      run: mvn clean package

    # ðŸ“Œ Ã‰tape 4 : Ajouter la clÃ© SSH
    - name: Configure SSH Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ecf.pem
        chmod 600 ecf.pem

    # ðŸ“Œ Ã‰tape 5 : DÃ©ployer l'application sur AWS
    - name: Deploy to AWS EC2
      env:
        EC2_IP: ${{ secrets.EC2_IP }}
      run: |
        echo "Transfert du fichier WAR..."
        scp -i ecf.pem -o StrictHostKeyChecking=no target/*.war admin@${EC2_IP}:/home/admin/app.war

        echo "RedÃ©marrage de Tomcat..."
        ssh -i ecf.pem admin@${EC2_IP} << 'EOF'
        sudo systemctl restart tomcat10
        EOF

    # ðŸ“Œ Ã‰tape 6 : VÃ©rifier le dÃ©ploiement
    - name: Check Deployment
      run: curl -I http://${{ secrets.EC2_IP }}:8080/app
